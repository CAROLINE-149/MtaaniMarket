<!-- marketApp/templates/marketApp/product_detail.html -->
{% extends 'main.html' %}

{% block title %}{{ product.title }} - Mtaani Market{% endblock %}

{% block content %}
<div class="container">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'shop' %}">Shop</a></li>
            <li class="breadcrumb-item active">{{ product.title|truncatechars:30 }}</li>
        </ol>
    </nav>
    
    <div class="row">
        <!-- Product Images - SIMPLIFIED VERSION -->
        <div class="col-lg-6">
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-images me-2"></i>Product Images</h5>
                </div>
                <div class="card-body p-3">
                    <!-- Main Image Display -->
                    <div class="main-image-container mb-4">
                        {% if product.images.all %}
                            {% with product.images.first as main_image %}
                            <img src="{{ main_image.image.url }}" 
                                 class="img-fluid rounded shadow-sm" 
                                 alt="{{ product.title }}"
                                 style="max-height: 400px; width: 100%; object-fit: contain;">
                            {% endwith %}
                        {% else %}
                        <div class="text-center py-5 bg-light rounded">
                            <i class="fas fa-image fa-5x text-secondary mb-3"></i>
                            <h5 class="text-muted">No Images Available</h5>
                            <p class="text-muted small">This product doesn't have any images yet.</p>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Thumbnail Gallery - SIMPLIFIED -->
                    {% if product.images.count > 0 %}
                    <div class="thumbnail-gallery">
                        <h6 class="mb-3 text-muted">
                            <i class="fas fa-th me-2"></i>Product Images
                            <span class="badge bg-secondary ms-2">{{ product.images.count }} total</span>
                        </h6>
                        
                        <div class="row g-2">
                            {% for image in product.images.all %}
                            <div class="col-3 col-sm-2">
                                <div class="thumbnail-item">
                                    <img src="{{ image.image.url }}" 
                                         class="img-fluid rounded border {% if forloop.first %}border-success border-2{% else %}border-light{% endif %}"
                                         style="height: 80px; width: 100%; object-fit: cover;"
                                         alt="Image {{ forloop.counter }}"
                                         title="{{ product.title }} - Image {{ forloop.counter }}">
                                    
                                    {% if image.is_primary %}
                                    <span class="badge bg-success position-absolute top-0 start-0 small">
                                        <i class="fas fa-star"></i>
                                    </span>
                                    {% endif %}
                                    
                                    <!-- Image indicator -->
                                    <div class="badge bg-dark position-absolute bottom-0 end-0 small">
                                        {{ forloop.counter }}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Product Details -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-body">
                    <h1 class="h3 mb-2">{{ product.title }}</h1>
                    
                    <!-- Seller Info -->
                    <div class="d-flex align-items-center mb-3">
                        {% if product.seller.profile.profile_picture %}
                        <img src="{{ product.seller.profile.profile_picture.url }}" 
                             class="rounded-circle me-2" width="40" height="40" 
                             alt="{{ product.seller.username }}">
                        {% else %}
                        <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center me-2" 
                             style="width: 40px; height: 40px;">
                            <i class="fas fa-user"></i>
                        </div>
                        {% endif %}
                        <div>
                            <strong>{{ product.seller.username }}</strong>
                            <div class="text-muted small">
                                <i class="fas fa-map-marker-alt"></i> {{ product.location }}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Price -->
                    <div class="mb-4">
                        <h2 class="text-success mb-1">Ksh {{ product.price }}</h2>
                        {% if product.is_negotiable %}
                        <span class="badge bg-warning text-dark">Price Negotiable</span>
                        {% endif %}
                    </div>
                    
                    <!-- Product Details -->
                    <div class="mb-4">
                        <h5 class="mb-3">Product Details</h5>
                        <table class="table table-sm">
                            <tr>
                                <th width="150">Condition:</th>
                                <td>{{ product.get_condition_display }}</td>
                            </tr>
                            <tr>
                                <th>Category:</th>
                                <td>{{ product.category.name }}</td>
                            </tr>
                            <tr>
                                <th>Brand:</th>
                                <td>{{ product.brand|default:"Not specified" }}</td>
                            </tr>
                            <tr>
                                <th>Quantity:</th>
                                <td>{{ product.quantity }} available</td>
                            </tr>
                            <tr>
                                <th>Views:</th>
                                <td>{{ product.views }}</td>
                            </tr>
                            <tr>
                                <th>Posted:</th>
                                <td>{{ product.created_at|date:"F d, Y" }}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <!-- Description -->
                    <div class="mb-4">
                        <h5 class="mb-3">Description</h5>
                        <p>{{ product.description|linebreaks }}</p>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="d-grid gap-2">
                        {% if request.user.is_authenticated %}
                            {% if request.user.profile.role == 'buyer' %}
                                {% if request.user != product.seller %}
                                <a href="{% url 'express_interest' product.id %}" class="btn btn-success btn-lg">
                                    <i class="fas fa-shopping-cart me-2"></i>Express Interest
                                </a>
                                <a href="{% url 'contact_via_whatsapp' product.id %}" class="btn btn-outline-success btn-lg">
                                    <i class="fab fa-whatsapp me-2"></i>Contact via WhatsApp
                                </a>
                                {% else %}
                                <a href="{% url 'edit_product' product.id %}" class="btn btn-primary btn-lg">
                                    <i class="fas fa-edit me-2"></i>Edit Product
                                </a>
                                {% endif %}
                            {% endif %}
                        {% else %}
                        <a href="{% url 'login' %}?next={% url 'product_detail' product.id %}" class="btn btn-success btn-lg">
                            <i class="fas fa-sign-in-alt me-2"></i>Login to Contact Seller
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Related Products -->
    {% if related_products %}
    <div class="mt-5">
        <h3 class="mb-4">Related Products</h3>
        <div class="row">
            {% for related in related_products %}
            <div class="col-md-3 mb-4">
                <div class="card h-100">
                    {% if related.images.first %}
                    <img src="{{ related.images.first.image.url }}" class="card-img-top" alt="{{ related.title }}" style="height: 150px; object-fit: cover;">
                    {% endif %}
                    <div class="card-body">
                        <h6 class="card-title">{{ related.title|truncatechars:30 }}</h6>
                        <p class="card-text text-success fw-bold">Ksh {{ related.price }}</p>
                        <a href="{% url 'product_detail' related.id %}" class="btn btn-sm btn-outline-success w-100">View</a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Simple CSS for image display -->
<style>
.thumbnail-item {
    position: relative;
    transition: transform 0.2s;
}

.thumbnail-item:hover {
    transform: translateY(-2px);
}

.main-image-container {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 300px;
}

.thumbnail-gallery .row {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}

@media (max-width: 768px) {
    .main-image-container {
        min-height: 250px;
    }
    
    .thumbnail-gallery .col-3 {
        flex: 0 0 calc(25% - 10px);
        max-width: calc(25% - 10px);
    }
}
</style>
{% endblock %}